let meta = `{
  "fork_sim_code": "ours",
  "start_date": "February 13, 2023",
  "curr_time": "February 13, 2023, 09:00:00",
  "sec_per_step": 15,
  "maze_name": "the_ville_and_ours",
  "persona_names": [
    "Dylan Yoon",
    "Emily Parker",
    "Helen Potter",
    "Johnny Kim",
    "Reynolds Liam",
    "Elowen Hart",
    "Ethan Reed",
    "James Mond",
    "Rain Forest",
    "Tina Thompson"
  ],
  "step": 0
}`;

let reverie = `{
  "persona": {
    "Dylan Yoon": {
      "movement": [
        21,
        74
      ],
      "pronunciatio": "\ud83d\ude42",
      "description": "resting on a sofa and reflecting on his remaining years @ the Ville:artist's co-living space:Latoya Williams's bathroom:shower",
      "chat": null
    },
    "Emily Parker": {
      "movement": [
        41,
        87
      ],
      "pronunciatio": "\ud83d\ude42",
      "description": "attending her first class at the university @ the Ville:Dorm for Oak Hill College:common room:common room table",
      "chat": null
    },
    "Helen Potter": {
      "movement": [
        49,
        84
      ],
      "pronunciatio": "\ud83d\ude42",
      "description": "exploring the artwork at the gallery @ the Ville:Gallery:firsh exhibit place stand exhibit:first piece",
      "chat": null
    },
    "Johnny Kim": {
      "movement": [
        44,
        88
      ],
      "pronunciatio": "\ud83d\ude42",
      "description": "prepping for his lecture at the university @ the Ville:artist's co-living space:common room:common room table",
      "chat": null
    },
    "Reynolds Liam": {
      "movement": [
        41,
        86
      ],
      "pronunciatio": "\ud83d\ude42",
      "description": "attending England and America Literature class @ the Ville:Dorm for Oak Hill College:common room:common room table",
      "chat": null
    },
    "Elowen Hart": {
      "movement": [
        54,
        73
      ],
      "pronunciatio": "\ud83d\ude42",
      "description": "continuing to work on her new series of paintings in her home art studio @ the Ville:Arthur Burton's apartment:main room:desk",
      "chat": null
    },
    "Ethan Reed": {
      "movement": [
        76,
        81
      ],
      "pronunciatio": "\ud83d\ude42",
      "description": "working on remote projects @ the Ville:Hobbs Cafe:cafe:cafe customer seating",
      "chat": null
    },
    "James Mond": {
      "movement": [
        78,
        86
      ],
      "pronunciatio": "\ud83d\udcac",
      "description": "conversing about Rain Forest and James Mond are discussing the upcoming innovative art exhibition that will feature artists using generative AI to create mesmerizing abstract compositions and intricate 3D sculptures. @ <persona> Rain Forest",
      "chat": [
        [
          "Rain Forest",
          "Hey James, I noticed you're opening up the gallery today. Have you come across any new artworks that caught your eye?"
        ],
        [
          "James Mond",
          "Hey Rain, yes I'm always on the lookout for new pieces. In fact, we have some exciting new exhibitions coming up that you might be interested in."
        ],
        [
          "Rain Forest",
          "That sounds intriguing, James. I'm always interested in discovering new artists and their works. Could you tell me more about the upcoming exhibitions?"
        ],
        [
          "James Mond",
          "Certainly, Rain. We are planning an innovative exhibit focusing on generative AI and its impact on the art world. I think you'll find it quite fascinating."
        ],
        [
          "Rain Forest",
          "That sounds like a truly unique exhibit, James. I'd love to learn more about how generative AI is reshaping the art landscape. Do you have any specific artists or pieces lined up for the showcase?"
        ],
        [
          "James Mond",
          "Yes, Rain. We have a few standout artists who have created incredible pieces using generative AI algorithms. One of them is a young artist who combines traditional painting techniques with AI-generated patterns to create mesmerizing abstract compositions. I believe you'll appreciate the creativity and innovation on display."
        ],
        [
          "Rain Forest",
          "That sounds fascinating, James. I can't wait to see these innovative pieces firsthand. When will the exhibit be opening to the public?"
        ],
        [
          "James Mond",
          "The exhibit will be opening in two weeks, Rain. I'll make sure to send you an invitation once we have everything set up. It would be great to have your expert eye on these artworks."
        ],
        [
          "Rain Forest",
          "Thank you, James. I look forward to attending the exhibit and experiencing the innovative artworks firsthand. Please do send me the invitation once everything is ready."
        ],
        [
          "James Mond",
          "Sure, Rain. I'll keep you updated on the progress of the exhibit and make sure to send you the invitation as soon as everything is ready."
        ],
        [
          "Rain Forest",
          "Thank you, James. Your insight into the upcoming exhibit has piqued my interest. I can't wait to see the innovative pieces on display. Please do keep me updated on any developments."
        ],
        [
          "James Mond",
          "I will definitely keep you in the loop, Rain. It's always a pleasure to discuss art with someone as passionate as you."
        ],
        [
          "Rain Forest",
          "I'm glad to hear about the upcoming exhibit, James. I'll make sure to mark my calendar for the opening day. Looking forward to seeing those innovative pieces firsthand."
        ],
        [
          "James Mond",
          "I'm glad to hear that, Rain. Your presence at the exhibit will definitely add value to the experience. I'll keep you updated on any new developments or artists that are confirmed for the showcase."
        ],
        [
          "Rain Forest",
          "Thank you, James. I appreciate the insight into the upcoming exhibit and look forward to attending. Do you know if any other notable artists will be featured in the showcase besides the young artist you mentioned?"
        ],
        [
          "James Mond",
          "We are also in talks with a renowned sculptor who utilizes generative AI to create intricate 3D sculptures. Their work truly pushes the boundaries of traditional art forms."
        ]
      ]
    },
    "Rain Forest": {
      "movement": [
        77,
        86
      ],
      "pronunciatio": "\ud83d\udcac",
      "description": "conversing about Rain Forest and James Mond are discussing the upcoming innovative art exhibition that will feature artists using generative AI to create mesmerizing abstract compositions and intricate 3D sculptures. @ <persona> James Mond",
      "chat": [
        [
          "Rain Forest",
          "Hey James, I noticed you're opening up the gallery today. Have you come across any new artworks that caught your eye?"
        ],
        [
          "James Mond",
          "Hey Rain, yes I'm always on the lookout for new pieces. In fact, we have some exciting new exhibitions coming up that you might be interested in."
        ],
        [
          "Rain Forest",
          "That sounds intriguing, James. I'm always interested in discovering new artists and their works. Could you tell me more about the upcoming exhibitions?"
        ],
        [
          "James Mond",
          "Certainly, Rain. We are planning an innovative exhibit focusing on generative AI and its impact on the art world. I think you'll find it quite fascinating."
        ],
        [
          "Rain Forest",
          "That sounds like a truly unique exhibit, James. I'd love to learn more about how generative AI is reshaping the art landscape. Do you have any specific artists or pieces lined up for the showcase?"
        ],
        [
          "James Mond",
          "Yes, Rain. We have a few standout artists who have created incredible pieces using generative AI algorithms. One of them is a young artist who combines traditional painting techniques with AI-generated patterns to create mesmerizing abstract compositions. I believe you'll appreciate the creativity and innovation on display."
        ],
        [
          "Rain Forest",
          "That sounds fascinating, James. I can't wait to see these innovative pieces firsthand. When will the exhibit be opening to the public?"
        ],
        [
          "James Mond",
          "The exhibit will be opening in two weeks, Rain. I'll make sure to send you an invitation once we have everything set up. It would be great to have your expert eye on these artworks."
        ],
        [
          "Rain Forest",
          "Thank you, James. I look forward to attending the exhibit and experiencing the innovative artworks firsthand. Please do send me the invitation once everything is ready."
        ],
        [
          "James Mond",
          "Sure, Rain. I'll keep you updated on the progress of the exhibit and make sure to send you the invitation as soon as everything is ready."
        ],
        [
          "Rain Forest",
          "Thank you, James. Your insight into the upcoming exhibit has piqued my interest. I can't wait to see the innovative pieces on display. Please do keep me updated on any developments."
        ],
        [
          "James Mond",
          "I will definitely keep you in the loop, Rain. It's always a pleasure to discuss art with someone as passionate as you."
        ],
        [
          "Rain Forest",
          "I'm glad to hear about the upcoming exhibit, James. I'll make sure to mark my calendar for the opening day. Looking forward to seeing those innovative pieces firsthand."
        ],
        [
          "James Mond",
          "I'm glad to hear that, Rain. Your presence at the exhibit will definitely add value to the experience. I'll keep you updated on any new developments or artists that are confirmed for the showcase."
        ],
        [
          "Rain Forest",
          "Thank you, James. I appreciate the insight into the upcoming exhibit and look forward to attending. Do you know if any other notable artists will be featured in the showcase besides the young artist you mentioned?"
        ],
        [
          "James Mond",
          "We are also in talks with a renowned sculptor who utilizes generative AI to create intricate 3D sculptures. Their work truly pushes the boundaries of traditional art forms."
        ]
      ]
    },
    "Tina Thompson": {
      "movement": [
        99,
        77
      ],
      "pronunciatio": "\ud83d\ude42",
      "description": "arriving at the gallery and starting her shift at the information desk @ the Ville:Gallery:enterance infor:employee place",
      "chat": null
    }
  },
  "meta": {
    "curr_time": "February 13, 2023, 09:16:00"
  }
}`;

let move0 = `{
  "persona": {
    "Dylan Yoon": {
      "movement": [
        16,
        75
      ],
      "pronunciatio": "\ud83d\ude42",
      "description": "resting on a sofa and reflecting on his remaining years @ the Ville:artist's co-living space:Latoya Williams's bathroom:shower",
      "chat": null
    },
    "Emily Parker": {
      "movement": [
        26,
        75
      ],
      "pronunciatio": "\ud83d\ude42",
      "description": "attending her first class at the university @ the Ville:Dorm for Oak Hill College:common room:common room table",
      "chat": null
    },
    "Helen Potter": {
      "movement": [
        37,
        74
      ],
      "pronunciatio": "\ud83d\ude42",
      "description": "exploring the artwork at the gallery @ the Ville:Gallery:firsh exhibit place stand exhibit:first piece",
      "chat": null
    },
    "Johnny Kim": {
      "movement": [
        16,
        87
      ],
      "pronunciatio": "\ud83d\ude42",
      "description": "prepping for his lecture at the university @ the Ville:Dorm for Oak Hill College:common room:common room table",
      "chat": null
    },
    "Reynolds Liam": {
      "movement": [
        26,
        87
      ],
      "pronunciatio": "\ud83d\ude42",
      "description": "attending England and America Literature class @ the Ville:Dorm for Oak Hill College:common room:common room table",
      "chat": null
    },
    "Elowen Hart": {
      "movement": [
        54,
        70
      ],
      "pronunciatio": "\ud83d\ude42",
      "description": "continuing to work on her new series of paintings in her home art studio @ the Ville:Arthur Burton's apartment:main room:desk",
      "chat": null
    },
    "Ethan Reed": {
      "movement": [
        66,
        75
      ],
      "pronunciatio": "\ud83d\ude42",
      "description": "working on remote projects @ the Ville:Hobbs Cafe:cafe:cafe customer seating",
      "chat": null
    },
    "James Mond": {
      "movement": [
        73,
        70
      ],
      "pronunciatio": "\ud83d\ude42",
      "description": "heading to the gallery and opening for the day @ the Ville:Gallery:enterance infor:employee place",
      "chat": null
    },
    "Rain Forest": {
      "movement": [
        87,
        74
      ],
      "pronunciatio": "\ud83d\ude42",
      "description": "at the gallery, searching for exceptional artworks to purchase @ the Ville:Gallery:firsh exhibit place stand exhibit:first piece",
      "chat": null
    },
    "Tina Thompson": {
      "movement": [
        95,
        74
      ],
      "pronunciatio": "\ud83d\ude42",
      "description": "arriving at the gallery and starting her shift at the information desk @ the Ville:Gallery:enterance infor:employee place",
      "chat": null
    }
  },
  "meta": {
    "curr_time": "February 13, 2023, 09:00:00"
  }
}`;

meta = JSON.parse(meta);
move0 = JSON.parse(move0);
reverie = JSON.parse(reverie);

console.log(move0.persona);

// function place_npc() {
//   for (let key in reverie.persona) {
//     let npc = reverie.persona[key];
//     let [x, y] = npc.movement;

//     let npcObj = new buildNPC(key, x, y);
//     _npcs.push(npcObj);
//   }
// }

class system {
  constructor() {
    // request persona names to server
    // temp
    this.sprite_sheet_list = meta.persona_names;
    this.date = meta.curr_time;
  }

  // movement 0.json; place npc on the initial location
  init() {
    for (let key in this.sprite_sheet_list) {
      let npc = reverie.persona[key];
      let [x, y] = npc.movement;

      let npcObj = new buildNPC(key, x, y);
      _npcs.push(npcObj);
    }
  }

  isupdated(yet = false){
    let temp = reverie.curr_time;
    if (this.date != temp && yet) {
      this.date = temp;
      return true;
    }
    return false;
  }

  updateNPCs(dt){
    if (dt) {
      for (let npc of _npcs) {
        let [x, y] = reverie.persona[npc.name].movement;
        npc.move(x, y);
      }
    }
    return false;
  }

  onUpdate(){
    this.updateNPCs(this.isupdated());
  }

  isVaildMove(x, y){
    return 
  }

}

const _npcs = [];

class buildNPC {
  constructor(name, x, y) {
    if (name) this.name = name;
    else this.name = "NPC";

    if (x) this.x = x;
    else this.x = 0;

    if (y) this.y = y;
    else this.y = 0;

    this.caller = "";

    this.property = {
      key: this.name,
      moveSpeed: 80,
      useDirAnim: true,
      impassable: true,
      collide: true,
      offsetX: -8,
      offsetY: -32,
      oberlap: false,
      npcProperty: { name: this.name },
    };

    this.load_sprite("sprite000.png");

    this.build();
  }

  build() {
    Map.putObjectWithKey(this.x, this.y, this.sprite, {
      overlap: true,
      movespeed: 50,
      key: this.name,
      collide: true,
      useDirAnim: true,
      offsetX: -8,
      offsetY: -32,
      collide: true,
    });

    this.updateProperty();
    this.getLoc();
  }

  load_sprite(spriteName) {
    this.sprite = App.loadSpritesheet(
      spriteName,
      48,
      64,
      {
        left: [5, 6, 7, 8, 9], // 좌방향 이동 이미지
        up: [15, 16, 17, 18, 19],
        down: [0, 1, 2, 3, 4],
        right: [10, 11, 12, 13, 14],
        dance: [
          20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36,
          37,
        ],
        down_jump: [38],
        left_jump: [39],
        right_jump: [40],
        up_jump: [41],
      },
      10
    );
  }

  updateProperty() {
    this.property = Map.getObjectWithKey(this.name);
    return this.property;
  }

  //   get location of npc
  getLoc() {
    this.updateProperty();
    let { tileX, tileY } = this.property;

    this.x = tileX;
    this.y = tileY;

    return { x: this.x, y: this.y };
  }

  sayBallon(message) {
    Map.sayObjectWithKey(this.name, message);
  }

  sayToAll(message) {
    App.sayToAll(`[ ${this.name} ] ${message}`, 0xe0e0e0);
  }

  move(x, y) {
    return Map.moveObjectWithKey(this.name, x, y, true);
  }

  responseToPlayer(text) {
    let numbers = text.split(" ");

    // 배열의 각 요소를 숫자로 변환하여 x와 y에 할당
    let x = parseInt(numbers[0], 10);
    let y = parseInt(numbers[1], 10);

    this.move(x, y);

    // this.sayToAll(text);
    this.sayBallon(`(${x}, ${y})로 이동합니다.`);
  }

  //   // A* 알고리즘으로 최적 경로 계산
  // function calculatePath(start, end, obstacles) {
  //     // 경로 계산 로직 구현
  //     // ...
  //     // 임시적으로 현재 위치에서 목표 위치로 직선 경로를 반환하는 예시를 작성합니다.
  //     var path = [];
  //     var deltaX = end.x - start.x;
  //     var deltaY = end.y - start.y;
  //     var stepX = deltaX > 0 ? 1 : -1;
  //     var stepY = deltaY > 0 ? 1 : -1;
  //     var x = start.x;
  //     var y = start.y;

  //     while (x !== end.x || y !== end.y) {
  //         if (x !== end.x) {
  //             x += stepX;
  //         }
  //         if (y !== end.y) {
  //             y += stepY;
  //         }
  //         if (!isObstacle(x, y, obstacles)) {
  //             path.push({ x: x, y: y });
  //         } else {
  //             // 장애물이 있는 경우, 이동 중지
  //             break;
  //         }
  //     }

  //     return path;
  // }

  // // 특정 위치가 장애물인지 확인하는 함수
  // isObstacle(x, y) {
  //     let isValid =
  //     Map.getTile(2, x, y) === 0 &&
  // }

  destruct() {
    Map.putObjectWithKey(this.x, this.y, null, { key: this.name });
  }

  chatGPT_parse(url, body, callback) {
    App.httpPostJson(url, {}, body, (res) => {
      App.sayToAll(`${res}`, 0xffffff);
      // 요청 결과를 JSON 오브젝트로 변환
      let response = JSON.parse(res);
      App.sayToAll(`보낸 데이터: ${response.data.name}`, 0xffffff);
    });
  }
}

// App.onInit.Add(function () {
//   //NPC 추가
//   _npcs.push(new buildNPC("테스터", 21, 48));
// });

// App.onSay.add(function (player, text) {
//   //말해보기
//   for (let npc of _npcs) {
//     npc.responseToPlayer(text);
//   }
// });

// App.onUpdate.Add(function (dt) {
//   //위치 얻기
//   for (let npc of _npcs) {
//     npc.getLoc();
//   }
// });

// App.onDestroy.Add(function () {
//   //모든 오브젝트 제거
//   Map.clearAllObjects();
// });
